name: Build

on: push

jobs:
  build:
    runs-on: ubuntu-latest
    #container: rebble/pebble-sdk:4.5-2
    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install python2
          sudo update-alternatives --install /usr/bin/python python /usr/bin/python2.7 1
          curl https://bootstrap.pypa.io/pip/2.7/get-pip.py --output get-pip.py
          sudo python2 get-pip.py
          sudo -H python2.7 -m pip install -U pip setuptools wheel virtualenv
          sudo apt install python2-dev
          sudo apt install libnode-dev npm
          rm get-pip.py

      - name: Bootstrap Pebble SDK
        run: |
          mkdir ~/pebble-dev
          cd ~/pebble-dev
          wget https://developer.rebble.io/s3.amazonaws.com/assets.getpebble.com/pebble-tool/pebble-sdk-4.5-linux64.tar.bz2
          tar -xf pebble-sdk-4.5-linux64.tar.bz2
          cd pebble-sdk-4.5-linux64
          echo "$HOME/pebble-dev/pebble-sdk-4.5-linux64/bin" >> $GITHUB_PATH
          if [ "$(grep 'pebble-sdk-homebrew' requirements.txt)" ]; then cp requirements.txt requirements.txt.OLD; grep -v pypkjs requirements.txt.OLD > requirements.txt; echo 'git+https://github.com/pebble/pypkjs.git' >> requirements.txt; fi
          if [ "$(grep 'sdk.getpebble.com' pebble-tool/pebble_tool/sdk/manager.py)" ]; then sudo mv pebble-tool pebble-tool.OLD; sudo git clone https://github.com/pebble-dev/pebble-tool.git; fi
          [ -e .env ] || virtualenv --python=python2.7 .env
          . .env/bin/activate
          pip install -r requirements.txt
          pip install -r pebble-tool/requirements.txt
          deactivate

      - name: Install Pebble SDK
        run: yes | pebble sdk install latest

      - run: ls -al

      - name: Install project dependencies
        run: npm install

      - name: Build app
        run: pebble build

      - run: ls -al
